<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:VisioAnalytica.App.Risk.Converters"
             x:Class="VisioAnalytica.App.Risk.Pages.InspectionDetailsPage"
             Title="Detalles de InspecciÃ³n"
             BackgroundColor="White">
    
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:RiskLevelToColorConverter x:Key="RiskLevelToColorConverter" />
            <converters:RiskLevelToBgColorConverter x:Key="RiskLevelToBgColorConverter" />
            <converters:RiskLevelToTextColorConverter x:Key="RiskLevelToTextColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
    
    <ScrollView BackgroundColor="White">
        <VerticalStackLayout Padding="16" Spacing="16">
            
            <!-- Header con botÃ³n de regreso -->
            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12" VerticalOptions="Center">
                <Button Text="â† Volver"
                        Clicked="OnBackClicked"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource Primary}"
                        FontSize="16"
                        Padding="0"
                        HeightRequest="40"
                        Grid.Column="0" />
                <Label Text="Detalles de InspecciÃ³n"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="{StaticResource Gray900}"
                       VerticalOptions="Center"
                       Grid.Column="1" />
            </Grid>
            
            <!-- Inspection Info -->
            <Border Stroke="{StaticResource Gray300}"
                    StrokeThickness="1"
                    StrokeShape="RoundRectangle 12"
                    Padding="16"
                    BackgroundColor="White">
                <VerticalStackLayout Spacing="8">
                    <Label x:Name="CompanyNameLabel"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Gray900}" />
                    <Label x:Name="StatusLabel"
                           FontSize="14"
                           TextColor="{StaticResource Gray600}" />
                    <Label x:Name="DateRangeLabel"
                           FontSize="14"
                           TextColor="{StaticResource Gray600}" />
                </VerticalStackLayout>
            </Border>
            
            <!-- Photos with Findings -->
            <Label Text="Fotos Analizadas"
                   FontSize="18"
                   FontAttributes="Bold"
                   TextColor="{StaticResource Gray900}"
                   Margin="0,8,0,8" />
            
            <CollectionView x:Name="PhotosCollection"
                            ItemsSource="{Binding PhotoFindings}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border Stroke="{StaticResource Gray300}"
                                StrokeThickness="1"
                                StrokeShape="RoundRectangle 12"
                                Padding="16"
                                Margin="0,0,0,16"
                                BackgroundColor="White">
                            <VerticalStackLayout Spacing="12">
                                <!-- Photo Image -->
                                <Border Stroke="{StaticResource Gray300}"
                                        StrokeThickness="1"
                                        StrokeShape="RoundRectangle 8"
                                        Padding="4"
                                        BackgroundColor="{StaticResource Gray100}">
                                    <Grid HeightRequest="250" BackgroundColor="White">
                                        <Image Source="{Binding ImageSource}"
                                               Aspect="AspectFit" />
                                        <VerticalStackLayout HorizontalOptions="Center"
                                                           VerticalOptions="Center"
                                                           Spacing="8"
                                                           IsVisible="False">
                                            <VerticalStackLayout.Triggers>
                                                <DataTrigger TargetType="VerticalStackLayout" Binding="{Binding ImageSource}" Value="{x:Null}">
                                                    <Setter Property="IsVisible" Value="True" />
                                                </DataTrigger>
                                            </VerticalStackLayout.Triggers>
                                            <Label Text="ðŸ“·"
                                                   FontSize="48"
                                                   HorizontalOptions="Center" />
                                            <Label Text="Cargando imagen..."
                                                   FontSize="12"
                                                   TextColor="{StaticResource Gray500}"
                                                   HorizontalOptions="Center" />
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                                
                                <!-- Photo Info -->
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="{Binding CapturedAt, StringFormat='ðŸ“… Capturada: {0:dd/MM/yyyy HH:mm}'}"
                                           FontSize="13"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Gray700}" />
                                    
                                    <Label Text="{Binding Description}"
                                           FontSize="12"
                                           TextColor="{StaticResource Gray600}" />
                                    
                                    <Label Text="âœ… Analizada"
                                           FontSize="12"
                                           TextColor="Green"
                                           IsVisible="{Binding IsAnalyzed}" />
                                    
                                    <Label Text="â³ Pendiente de anÃ¡lisis"
                                           FontSize="12"
                                           TextColor="Orange">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsAnalyzed}" Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>
                                </VerticalStackLayout>
                                
                                <!-- Findings -->
                                <Label Text="ðŸ” Hallazgos:"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Gray900}"
                                       Margin="0,8,0,4"
                                       IsVisible="{Binding IsAnalyzed}" />
                                
                                <CollectionView ItemsSource="{Binding Findings}"
                                                IsVisible="{Binding IsAnalyzed}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Border Stroke="{Binding RiskLevel, Converter={StaticResource RiskLevelToColorConverter}}"
                                                    StrokeThickness="2"
                                                    StrokeShape="RoundRectangle 8"
                                                    Padding="12"
                                                    Margin="0,0,0,8"
                                                    BackgroundColor="{Binding RiskLevel, Converter={StaticResource RiskLevelToBgColorConverter}}">
                                                <VerticalStackLayout Spacing="8">
                                                    <Label Text="{Binding Description}"
                                                           FontSize="14"
                                                           FontAttributes="Bold"
                                                           TextColor="{StaticResource Gray900}" />
                                                    
                                                    <Border BackgroundColor="{Binding RiskLevel, Converter={StaticResource RiskLevelToBgColorConverter}}"
                                                            Stroke="{Binding RiskLevel, Converter={StaticResource RiskLevelToColorConverter}}"
                                                            StrokeThickness="1"
                                                            StrokeShape="RoundRectangle 4"
                                                            Padding="6,2"
                                                            HorizontalOptions="Start">
                                                        <Label Text="{Binding RiskLevel, StringFormat='Riesgo: {0}'}"
                                                               FontSize="11"
                                                               FontAttributes="Bold"
                                                               TextColor="{Binding RiskLevel, Converter={StaticResource RiskLevelToTextColorConverter}}" />
                                                    </Border>
                                                    
                                                    <VerticalStackLayout Spacing="4" Margin="0,4,0,0">
                                                        <Label Text="ðŸ”§ AcciÃ³n Correctiva:"
                                                               FontSize="11"
                                                               FontAttributes="Bold"
                                                               TextColor="{StaticResource Gray700}" />
                                                        <Label Text="{Binding CorrectiveAction}"
                                                               FontSize="12"
                                                               TextColor="{StaticResource Gray600}"
                                                               Margin="8,0,0,0" />
                                                    </VerticalStackLayout>
                                                    
                                                    <VerticalStackLayout Spacing="4" Margin="0,4,0,0">
                                                        <Label Text="ðŸ›¡ï¸ AcciÃ³n Preventiva:"
                                                               FontSize="11"
                                                               FontAttributes="Bold"
                                                               TextColor="{StaticResource Gray700}" />
                                                        <Label Text="{Binding PreventiveAction}"
                                                               FontSize="12"
                                                               TextColor="{StaticResource Gray600}"
                                                               Margin="8,0,0,0" />
                                                    </VerticalStackLayout>
                                                </VerticalStackLayout>
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                    <CollectionView.EmptyView>
                                        <Border Stroke="{StaticResource Gray300}"
                                                StrokeThickness="1"
                                                StrokeShape="RoundRectangle 8"
                                                Padding="16"
                                                Margin="0,8,0,0"
                                                BackgroundColor="{StaticResource Gray50}">
                                            <Label Text="âœ… No se encontraron hallazgos en esta foto"
                                                   FontSize="13"
                                                   TextColor="{StaticResource Gray600}"
                                                   HorizontalOptions="Center" />
                                        </Border>
                                    </CollectionView.EmptyView>
                                </CollectionView>
                                
                                <!-- Message for non-analyzed photos -->
                                <Border Stroke="Orange"
                                        StrokeThickness="1"
                                        StrokeShape="RoundRectangle 8"
                                        Padding="12"
                                        Margin="0,8,0,0"
                                        BackgroundColor="#FFF3E0">
                                    <Border.Triggers>
                                        <DataTrigger TargetType="Border" Binding="{Binding IsAnalyzed}" Value="True">
                                            <Setter Property="IsVisible" Value="False" />
                                        </DataTrigger>
                                    </Border.Triggers>
                                    <Label Text="â³ Esta foto aÃºn no ha sido analizada. Los hallazgos aparecerÃ¡n aquÃ­ una vez que se complete el anÃ¡lisis."
                                           FontSize="12"
                                           TextColor="Orange"
                                           HorizontalOptions="Center"
                                           HorizontalTextAlignment="Center" />
                                </Border>
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       Spacing="8"
                                       Padding="20">
                        <Label Text="ðŸ“‹"
                               FontSize="48"
                               HorizontalOptions="Center" />
                        <Label Text="No hay fotos analizadas"
                               FontSize="14"
                               TextColor="{StaticResource Gray600}"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
            
            <!-- Loading Indicator -->
            <ActivityIndicator x:Name="LoadingIndicator"
                               IsRunning="False"
                               IsVisible="False"
                               Color="{StaticResource Primary}"
                               Margin="0,20,0,0" />
            
        </VerticalStackLayout>
    </ScrollView>
    
</ContentPage>

